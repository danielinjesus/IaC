# Random string for unique naming
resource "random_string" "suffix" {
  count   = var.create_ml_workspace ? var.live_workspace_count : 0
  length  = 6
  special = false
  upper   = false
}

# Application Insights (ML Workspace 필수 구성요소)
resource "azurerm_application_insights" "ml_insights" {
  count               = var.create_ml_workspace ? var.live_workspace_count : 0
  name                = format("%02dinsights%s", count.index + 1, var.user_suffix)
  location            = azurerm_resource_group.rg[count.index].location
  resource_group_name = azurerm_resource_group.rg[count.index].name
  application_type    = "web"
}

# Key Vault (ML Workspace 필수 구성요소)
resource "azurerm_key_vault" "ml_kv" {
  count                      = var.create_ml_workspace ? var.live_workspace_count : 0
  name                       = format("%02dkv%s%s", count.index + 1, var.user_suffix, random_string.suffix[count.index].result)
  location                   = azurerm_resource_group.rg[count.index].location
  resource_group_name        = azurerm_resource_group.rg[count.index].name
  enabled_for_disk_encryption = true
  tenant_id                  = var.tenant_id
  soft_delete_retention_days = 7
  purge_protection_enabled   = false
  sku_name                   = "standard"
}

# Storage Account (ML Workspace 필수 구성요소)
resource "azurerm_storage_account" "ml_storage" {
  count                    = var.create_ml_workspace ? var.live_workspace_count : 0
  name                     = format("%02dstorage%s%s", count.index + 1, lower(var.user_suffix), random_string.suffix[count.index].result)
  resource_group_name      = azurerm_resource_group.rg[count.index].name
  location                 = azurerm_resource_group.rg[count.index].location
  account_tier             = "Standard"
  account_replication_type = "LRS"
}

# Container Registry (ML Workspace 필수 구성요소)
resource "azurerm_container_registry" "ml_acr" {
  count               = var.create_ml_workspace ? var.live_workspace_count : 0
  name                = format("%02dacr%s%s", count.index + 1, lower(var.user_suffix), random_string.suffix[count.index].result)
  resource_group_name = azurerm_resource_group.rg[count.index].name
  location            = azurerm_resource_group.rg[count.index].location
  sku                 = "Basic"
  admin_enabled       = true
}

# ML Workspace 생성
resource "azurerm_machine_learning_workspace" "ml_workspace" {
  count                   = var.create_ml_workspace ? var.live_workspace_count : 0
  name                    = format("%02dmlworkspace%s", count.index + 1, var.user_suffix)
  location                = azurerm_resource_group.rg[count.index].location
  resource_group_name     = azurerm_resource_group.rg[count.index].name
  application_insights_id = azurerm_application_insights.ml_insights[count.index].id
  key_vault_id            = azurerm_key_vault.ml_kv[count.index].id
  storage_account_id      = azurerm_storage_account.ml_storage[count.index].id
  container_registry_id   = azurerm_container_registry.ml_acr[count.index].id

  identity {
    type = "SystemAssigned"
  }

  depends_on = [
    azurerm_application_insights.ml_insights,
    azurerm_key_vault.ml_kv,
    azurerm_storage_account.ml_storage,
    azurerm_container_registry.ml_acr
  ]
}

# Key Vault Access Policy for ML Workspace
resource "azurerm_key_vault_access_policy" "ml_workspace_policy" {
  count        = var.create_ml_workspace ? var.live_workspace_count : 0
  key_vault_id = azurerm_key_vault.ml_kv[count.index].id
  tenant_id    = var.tenant_id
  object_id    = azurerm_machine_learning_workspace.ml_workspace[count.index].identity[0].principal_id

  key_permissions = [
    "Get", "List", "Create", "Delete", "Update", "Recover", "Purge"
  ]

  secret_permissions = [
    "Get", "List", "Set", "Delete", "Recover", "Purge"
  ]

  certificate_permissions = [
    "Get", "List", "Create", "Delete", "Update", "Recover", "Purge"
  ]

  depends_on = [azurerm_machine_learning_workspace.ml_workspace]
}

# Key Vault Access Policy for Users
resource "azurerm_key_vault_access_policy" "user_kv_policy" {
  count        = var.create_ml_workspace ? var.live_workspace_count : 0
  key_vault_id = azurerm_key_vault.ml_kv[count.index].id
  tenant_id    = var.tenant_id
  object_id    = azuread_user.rag_users[count.index].object_id

  secret_permissions = [
    "Get", "List", "Set"
  ]

  depends_on = [azuread_user.rag_users, azurerm_key_vault.ml_kv]
}

# ML Compute Instance 생성 (Standard_E4ds_v4, 2시간 idle shutdown)
resource "azapi_resource" "ml_compute_instance" {
  count     = var.create_ml_workspace ? var.live_workspace_count : 0
  type      = "Microsoft.MachineLearningServices/workspaces/computes@2023-04-01"
  name      = format("%02dcomputeinstance%s", count.index + 1, var.user_suffix)
  parent_id = azurerm_machine_learning_workspace.ml_workspace[count.index].id

  body = jsonencode({
    properties = {
      computeType = "ComputeInstance"
      properties = {
        vmSize = var.ml_vm_size
        idleTimeBeforeShutdown = var.ml_idle_shutdown
        personalComputeInstanceSettings = {
          assignedUser = {
            objectId = azuread_user.rag_users[count.index].object_id
            tenantId = var.tenant_id
          }
        }
      }
    }
  })

  depends_on = [azurerm_machine_learning_workspace.ml_workspace]
}

resource "null_resource" "start_ml_computes" {
  count = var.create_ml_workspace && var.start_computes ? var.live_workspace_count : 0

  provisioner "local-exec" {
    command = <<-EOT
      az ml compute start \
        --name "${format("%02dcomputeinstance%s", count.index + 1, var.user_suffix)}" \
        --workspace-name "${azurerm_machine_learning_workspace.ml_workspace[count.index].name}" \
        --resource-group "${azurerm_resource_group.rg[count.index].name}" \
        --no-wait
      
      echo "Started compute: ${format("%02dcomputeinstance%s", count.index + 1, var.user_suffix)}"
    EOT
  }

  depends_on = [azapi_resource.ml_compute_instance]
}

resource "null_resource" "upload_initial_notebooks" {
  count = var.create_ml_workspace && var.upload_initial_notebooks ? var.live_workspace_count : 0

  # 워크스페이스가 생성된 후에 이 리소스가 실행되도록 의존성 설정
  depends_on = [azurerm_machine_learning_workspace.ml_workspace]

  provisioner "local-exec" {
    when        = create # 리소스가 처음 생성될 때만 실행
    interpreter = ["pwsh", "-Command"] # PowerShell 사용
    command     = <<-EOT
      $ErrorActionPreference = "Stop"
      try {
        Write-Host "Attempting to upload initial notebooks from '${var.notebook_source_path}' to workspace '${azurerm_machine_learning_workspace.ml_workspace[count.index].name}' (RG: '${azurerm_resource_group.rg[count.index].name}')"
        az ml datastore upload --name workspacefilestore `
          --workspace-name "${azurerm_machine_learning_workspace.ml_workspace[count.index].name}" `
          --resource-group "${azurerm_resource_group.rg[count.index].name}" `
          --subscription-id "${var.subscription_id}" `
          --path "${var.notebook_source_path}" `
          --target-path "initial_notebooks" `
          --overwrite true # 초기 업로드 시 덮어쓰기 허용
        Write-Host "Successfully initiated upload of initial notebooks for workspace '${azurerm_machine_learning_workspace.ml_workspace[count.index].name}'."
      } catch {
        Write-Error "Failed to upload initial notebooks for workspace '${azurerm_machine_learning_workspace.ml_workspace[count.index].name}'. Error: $_"
        exit 1
      }
    EOT
  }
}

# Azure OpenAI Service Account 생성
resource "azurerm_cognitive_account" "openai_service" {
  count               = var.create_ml_workspace && var.enable_azure_openai ? var.live_workspace_count : 0
  name                = format("%02daoiservice%s%s", count.index + 1, lower(var.user_suffix), random_string.suffix[count.index].result) # random_string.suffix 사용
  location            = azurerm_resource_group.rg[count.index].location
  resource_group_name = azurerm_resource_group.rg[count.index].name
  kind                = "OpenAI"
  sku_name            = var.azure_openai_sku_name
  tags = {
    environment = "rag_project"
    user_index  = format("%02d", count.index + 1)
  }
  depends_on = [azurerm_resource_group.rg, random_string.suffix]
}
# Azure OpenAI GPT 모델 배포
resource "azurerm_cognitive_deployment" "gpt_model_deployment" {
  count                 = var.create_ml_workspace && var.enable_azure_openai ? var.live_workspace_count : 0
  name                  = format("%02dgptdeploy%s", count.index + 1, var.user_suffix)
  cognitive_account_id  = azurerm_cognitive_account.openai_service[count.index].id
  resource_group_name   = azurerm_resource_group.rg[count.index].name # Cognitive Deployment는 RG 이름도 필요
  model {
    format = "OpenAI"
    name   = var.azure_openai_gpt_model_name
    version = var.azure_openai_model_version # 일부 모델은 버전 지정 필수
  }
  scale {
    type = "Standard" # 또는 "Manual" 등, 모델 및 SKU에 따라 다름
  }
  depends_on = [azurerm_cognitive_account.openai_service]
}
# Azure OpenAI Embedding 모델 배포
resource "azurerm_cognitive_deployment" "embedding_model_deployment" {
  count                 = var.create_ml_workspace && var.enable_azure_openai ? var.live_workspace_count : 0
  name                  = format("%02dembeddeploy%s", count.index + 1, var.user_suffix)
  cognitive_account_id  = azurerm_cognitive_account.openai_service[count.index].id
  resource_group_name   = azurerm_resource_group.rg[count.index].name # Cognitive Deployment는 RG 이름도 필요
  model {
    format = "OpenAI"
    name   = var.azure_openai_embedding_model_name
    version = "2" # text-embedding-ada-002의 일반적인 버전은 "2" 입니다. text-embedding-3-small의 경우 확인 필요
  }
  scale {
    type = "Standard"
  }
  depends_on = [azurerm_cognitive_account.openai_service]
}
